<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>VoCC • VoCC</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="VoCC">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">VoCC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/VoCC.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/MathMarEcol/VoCC/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>VoCC</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MathMarEcol/VoCC/blob/HEAD/vignettes/VoCC.Rmd" class="external-link"><code>vignettes/VoCC.Rmd</code></a></small>
      <div class="d-none name"><code>VoCC.Rmd</code></div>
    </div>

    
    
<p><strong>THIS IS A WORK IN PROGRESS TO CONVERT THE OLD RASTER-BASED
VOCC PACKAGE TO TERRA. NOT EVERYTHING WORKS YET. IN PARTICULAR
CONNECTIVITY IS NOT IMPLEMENTED SO ONLY EXAMPLE 1 BELOW
WORKS.</strong></p>
<p>This vignette provides the code to reproduce the examples for the R
package VoCC as presented in Garcia Molinos et al. (2019). Refer to the
paper and the function documentation for details on function options,
considerations on the argument choices and interepretation of
output.</p>
<p>For this tutorial we need the following packages (if not installed
get them first):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mathmarecol.github.io/VoCC/" class="external-link">VoCC</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/" class="external-link">tidyterra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span></code></pre></div>
<p>We also need a few data sets that can be accessed from the
<code>VoCCdata</code> package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">VoCCdata</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="example-1-prediction-of-biogeographical-shifts">Example 1: Prediction of biogeographical shifts<a class="anchor" aria-label="anchor" href="#example-1-prediction-of-biogeographical-shifts"></a>
</h2>
<p>We have a look first at the “marshift” global data set containing
reported range shifts in marine species corresponding to given periods
of time.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">marshift</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    343 obs. of  6 variables:</span></span>
<span><span class="co">#&gt;  $ lat       : num  49.7 53.8 53.8 40 43 ...</span></span>
<span><span class="co">#&gt;  $ long      : num  -4.33 5 5 1 -9.3 -1.4 -9.3 -71.7 -71.7 -71.7 ...</span></span>
<span><span class="co">#&gt;  $ timespan  : int  30 40 40 55 35 35 84 39 26 54 ...</span></span>
<span><span class="co">#&gt;  $ years_data: int  23 40 40 15 4 2 5 2 2 2 ...</span></span>
<span><span class="co">#&gt;  $ taxa      : Factor w/ 12 levels "Benthic algae",..: 6 6 6 6 3 3 4 5 5 5 ...</span></span>
<span><span class="co">#&gt;  $ Shift     : num  536.1 65.6 95.9 40 10 ...</span></span></code></pre></div>
<p>Next, we calculate the gradient- and distance-based velocities
(1960-2009), using the HadiSST data set, from which we will later
extract the corresponding values for each observed shift.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">HadiSST</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"HadiSST.tif"</span>, package <span class="op">=</span> <span class="st">"VoCCdata"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># monthly to annual averages</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sumSeries.html">sumSeries</a></span><span class="op">(</span><span class="va">HadiSST</span>, p <span class="op">=</span> <span class="st">"1960-01/2009-12"</span>, yr0 <span class="op">=</span> <span class="st">"1955-01-01"</span>, </span>
<span>               l <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">HadiSST</span><span class="op">)</span>, </span>
<span>               fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rowSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>               freqin <span class="op">=</span> <span class="st">"months"</span>, freqout <span class="op">=</span> <span class="st">"years"</span><span class="op">)</span></span>
<span><span class="co"># temporal trend</span></span>
<span><span class="va">vt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tempTrend.html">tempTrend</a></span><span class="op">(</span><span class="va">r</span>, th <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co"># spatial gradient</span></span>
<span><span class="va">vg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatGrad.html">spatGrad</a></span><span class="op">(</span><span class="va">r</span>, th <span class="op">=</span> <span class="fl">0.0001</span>, projected <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># climate velocity</span></span>
<span><span class="va">gv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gVoCC.html">gVoCC</a></span><span class="op">(</span><span class="va">vt</span>, <span class="va">vg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now the distance-based velocities</span></span>
<span><span class="co"># Take 1960-1970 as base period against 2000-2009</span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">r</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">r</span><span class="op">[[</span><span class="fl">41</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># prepare the data frame with the necessary variables</span></span>
<span><span class="va">clim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span>, cid <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clim</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">xyFromCell</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">clim</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span></span>
<span><span class="co"># 1965-2004 (40 yr), 500 km search radius</span></span>
<span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dVoCC.html">dVoCC</a></span><span class="op">(</span><span class="va">clim</span>, n <span class="op">=</span> <span class="fl">1</span>, tdiff <span class="op">=</span> <span class="fl">40</span>, method <span class="op">=</span> <span class="st">"Single"</span>, climTol <span class="op">=</span> <span class="fl">0.1</span>, geoTol <span class="op">=</span> <span class="fl">500</span>, distfun <span class="op">=</span> <span class="st">"GreatCircle"</span>, trans <span class="op">=</span> <span class="cn">NA</span>, lonlat <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Next, we extract the mean velocity estimates for each reported shift
by taking the average of all grid cell values within a circle of radius
equal to the reported range-shift distance. These are then used to fit
the simple linear regression models of observed range shifts against
climate velocity. Distance-based velocities are strictly positive by
definition, so to compare like with like we change first their sign to
negative where present local climates are warmer than their future
analogues.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Change sign as needed and create the distance-based velocity raster</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">r2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">v</span><span class="op">$</span><span class="va">focal</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">r2</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">v</span><span class="op">$</span><span class="va">target</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">v</span><span class="op">$</span><span class="va">velBis</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">$</span><span class="va">vel</span></span>
<span><span class="va">v</span><span class="op">$</span><span class="va">velBis</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">$</span><span class="va">vel</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="co"># put output in raster format</span></span>
<span><span class="va">dv</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">gv</span><span class="op">)</span></span>
<span><span class="va">dv</span><span class="op">[</span><span class="va">v</span><span class="op">$</span><span class="va">focal</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">$</span><span class="va">velBis</span></span>
<span></span>
<span><span class="co"># Create point geometries and buffer them</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">marshift</span><span class="op">$</span><span class="va">long</span>, <span class="va">marshift</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span>, crs <span class="op">=</span> <span class="st">"EPSG:4326"</span><span class="op">)</span></span>
<span><span class="va">buffer_size</span> <span class="op">&lt;-</span> <span class="va">marshift</span><span class="op">$</span><span class="va">Shift</span> <span class="op">*</span> <span class="op">(</span><span class="va">marshift</span><span class="op">$</span><span class="va">timespan</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="va">marshift</span><span class="op">$</span><span class="va">GV</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">gv</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/buffer.html" class="external-link">buffer</a></span><span class="op">(</span><span class="va">coords</span>, <span class="va">buffer_size</span><span class="op">)</span>, </span>
<span>                              fun <span class="op">=</span> <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">voccMag</span> <span class="co"># TODO The other option is voccAng but they seem the same. Check data above.</span></span>
<span></span>
<span><span class="va">marshift</span><span class="op">$</span><span class="va">DV</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">dv</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/buffer.html" class="external-link">buffer</a></span><span class="op">(</span><span class="va">coords</span>, <span class="va">buffer_size</span><span class="op">)</span>, </span>
<span>                              fun <span class="op">=</span> <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">voccMag</span>  <span class="co"># The other option is voccAng</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fit the regression models</span></span>
<span><span class="va">Mgv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Shift</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">GV</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">marshift</span>, weights <span class="op">=</span> <span class="va">years_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">Mgv</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Shift^(1/4) ~ I((GV * 10)^(1/4)), data = marshift, </span></span>
<span><span class="co">#&gt;     weights = years_data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Weighted Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -9.3704 -2.3595 -0.7102  1.7944 14.8587 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;                    Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)          0.9542     0.2467   3.869 0.000131 ***</span></span>
<span><span class="co">#&gt; I((GV * 10)^(1/4))   0.6028     0.1006   5.994 5.22e-09 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 3.821 on 340 degrees of freedom</span></span>
<span><span class="co">#&gt;   (1 observation deleted due to missingness)</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.09558,    Adjusted R-squared:  0.09292 </span></span>
<span><span class="co">#&gt; F-statistic: 35.93 on 1 and 340 DF,  p-value: 5.217e-09</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mdv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Shift</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">DV</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">marshift</span>, weights <span class="op">=</span> <span class="va">years_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">Mdv</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Shift^(1/4) ~ I((DV * 10)^(1/4)), data = marshift, </span></span>
<span><span class="co">#&gt;     weights = years_data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Weighted Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -9.9702 -2.5047 -0.8118  1.6606 15.5742 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;                    Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)          0.4845     0.3668   1.321    0.187    </span></span>
<span><span class="co">#&gt; I((DV * 10)^(1/4))   0.7660     0.1455   5.266  2.5e-07 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 3.883 on 335 degrees of freedom</span></span>
<span><span class="co">#&gt;   (6 observations deleted due to missingness)</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.07644,    Adjusted R-squared:  0.07369 </span></span>
<span><span class="co">#&gt; F-statistic: 27.73 on 1 and 335 DF,  p-value: 2.502e-07</span></span></code></pre></div>
<p>Produce the observed vs predicted scatterplots with regression lines
(Fig. 2 in Garcia Molinos et al. 2019).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># first compare both velocities</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">gv</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"RdBu"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Gradient-based vocc"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">gv</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"RdBu"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Distance-based vocc"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="VoCC_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># scatter plots with the resulting regression line</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">marshift</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">(</span><span class="va">GV</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">Shift</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="va">lm</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Accent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Predicted shift (x^1/4; km/yr)"</span>, y <span class="op">=</span> <span class="st">"Observed shift (y^1/4; km/yr)"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">marshift</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">(</span><span class="va">DV</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">Shift</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="va">lm</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Accent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Predicted shift (x^1/4; km/yr)"</span>, y <span class="op">=</span> <span class="st">"Observed shift (y^1/4; km/yr)"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using formula = 'y ~ x'</span></span>
<span><span class="co">#&gt; `geom_smooth()` using formula = 'y ~ x'</span></span></code></pre></div>
<p><img src="VoCC_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="example-2-analysis-of-climate-exposure-and-connectivity-in-the-western-pacific-ocean">Example 2: Analysis of climate exposure and connectivity in the
Western Pacific Ocean<a class="anchor" aria-label="anchor" href="#example-2-analysis-of-climate-exposure-and-connectivity-in-the-western-pacific-ocean"></a>
</h2>
<p><strong>THIS CODE IS NOT OPERATIONAL YET. IN PARTICULAR,
<code>voccTraj</code> HAS NOT BEEN UPDATED FOR <code>terra</code>.
Standby for updates.</strong></p>
<p>In this example we use climate velocity trajectories (based on
1960-2009 mean annual SST) to analyse climate connectivity in the
Western Pacific region and calculate the residence time corresponding to
the exclusive economic zones in the region as an index of climatic
exposure. First, we arrange the raster layers for analysis.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># prepare raster layers</span></span>
<span><span class="va">vel</span> <span class="op">&lt;-</span> <span class="va">gv</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">ang</span> <span class="op">&lt;-</span> <span class="va">gv</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">mn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generate a velocity layer centered and cropped to study region to extract the initial coordinates for the trajectories from</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">gv</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">90</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">gv</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">180</span>, <span class="op">-</span><span class="fl">90</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">180</span>, <span class="fl">360</span>, <span class="op">-</span><span class="fl">90</span>, <span class="fl">90</span><span class="op">)</span></span>
<span><span class="va">velc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span><span class="co"># crop to the desired extent</span></span>
<span><span class="co"># display restricted to +180 longitude to avoid plotting issues with date line crossing</span></span>
<span><span class="va">velc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">velc</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">90</span>, <span class="fl">180</span>, <span class="op">-</span><span class="fl">32</span>, <span class="fl">33</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can now populate the data frame with the cell centroid coordinates
for the trajectories and associated input data</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lonlat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">xyFromCell</a></span><span class="op">(</span><span class="va">velc</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">velc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lonlat</span><span class="op">$</span><span class="va">vel</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">vel</span>, <span class="va">lonlat</span>, ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">lonlat</span><span class="op">$</span><span class="va">ang</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">ang</span>, <span class="va">lonlat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">lonlat</span><span class="op">$</span><span class="va">mn</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">mn</span>, <span class="va">lonlat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">lonlat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">lonlat</span><span class="op">)</span></span></code></pre></div>
<p>Let’s calculate the trajectories with parallel processing to
demonstrate how this can be used to speed things up (especially useful
when dealing with fine resolutions or large extents).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cores</span> <span class="op">&lt;-</span> <span class="fu">detectCores</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ncores</span> <span class="op">&lt;-</span> <span class="va">cores</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">cuts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lonlat</span><span class="op">)</span>, <span class="va">ncores</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="va">ncores</span><span class="op">)</span></span>
<span><span class="fu">registerDoParallel</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span><span class="va">traj</span> <span class="op">&lt;-</span> <span class="fu">foreach</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/factors.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">cuts</span><span class="op">)</span>, .combine <span class="op">=</span> <span class="va">rbind</span>, .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"raster"</span>, <span class="st">"sp"</span>, <span class="st">"rgeos"</span>, <span class="st">"geosphere"</span>, <span class="st">"rgdal"</span>, <span class="st">"VoCC"</span><span class="op">)</span>, .multicombine <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span></span>
<span>  <span class="fu">voccTraj</span><span class="op">(</span><span class="va">lonlat</span><span class="op">[</span><span class="va">cuts</span> <span class="op">==</span> <span class="va">x</span>, <span class="op">]</span>, <span class="va">vel</span>, <span class="va">ang</span>, <span class="va">mn</span>, tyr <span class="op">=</span> <span class="fl">50</span>, trajID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">lonlat</span><span class="op">[</span><span class="va">cuts</span> <span class="op">==</span> <span class="va">x</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>, correct <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Plot them over the climate velocities and the EEZ polygons from the
EEZs data set (Fig. 3a in Garcia Molinos et al. 2019)</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simplify polygons to speed plotting up</span></span>
<span><span class="va">eez_simp</span> <span class="op">&lt;-</span> <span class="fu">rgeos</span><span class="fu">::</span><span class="fu">gSimplify</span><span class="op">(</span><span class="va">EEZs</span>, tol <span class="op">=</span> <span class="fl">0.5</span>, topologyPreserve <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">velc</span><span class="op">)</span></span>
<span><span class="co"># create the spatial object with the trajectories and plot them together with the EEZ polygons</span></span>
<span><span class="va">lns</span> <span class="op">&lt;-</span> <span class="fu">trajLine</span><span class="op">(</span>x <span class="op">=</span> <span class="va">traj</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lns</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eez_simp</span>, col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">211</span>, <span class="fl">211</span>, <span class="fl">211</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We now calulcate the trajectory classes and residence times for each
EEZ using the traj25 data set.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get the set of starting cells for the trajectories and calculate trajectories</span></span>
<span><span class="co"># at 1/4-deg resolution (16 trajectories per 1-deg cell)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">disaggregate</span><span class="op">(</span><span class="va">mn</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">lonlat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">xyFromCell</a></span><span class="op">(</span><span class="va">vel</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">vel</span><span class="op">)</span><span class="op">)</span>, <span class="va">vel</span><span class="op">[</span><span class="op">]</span>, <span class="va">ang</span><span class="op">[</span><span class="op">]</span>, <span class="va">mn</span><span class="op">[</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">traj25</span> <span class="op">&lt;-</span> <span class="fu">voccTraj</span><span class="op">(</span><span class="va">lonlat</span>, <span class="va">vel</span>, <span class="va">ang</span>, <span class="va">mn</span>, tyr <span class="op">=</span> <span class="fl">50</span>, correct <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># classify trajectories (16 trajectories starting from each 1-deg cell cell)</span></span>
<span><span class="va">clas</span> <span class="op">&lt;-</span> <span class="fu">trajClas</span><span class="op">(</span><span class="va">traj25</span>, <span class="va">vel</span>, <span class="va">ang</span>, <span class="va">mn</span>, trajSt <span class="op">=</span> <span class="fl">16</span>, tyr <span class="op">=</span> <span class="fl">50</span>, nmL <span class="op">=</span> <span class="fl">20</span>, smL <span class="op">=</span> <span class="fl">100</span>, Nend <span class="op">=</span> <span class="fl">45</span>, Nst <span class="op">=</span> <span class="fl">15</span>, NFT <span class="op">=</span> <span class="fl">70</span><span class="op">)</span></span>
<span><span class="co"># Extract proportions by categories for each EEZ</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">clas</span><span class="op">[[</span><span class="fl">7</span><span class="op">]</span><span class="op">]</span>, <span class="va">EEZs</span>, df <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">v</span><span class="op">[</span>, <span class="va">TrajClas</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">TrajClas</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">v</span><span class="op">[</span>, <span class="va">ID</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.ordered</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># proportions by class</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html" class="external-link">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># residence times by EEZ</span></span>
<span><span class="va">EEZa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/resTime.html">resTime</a></span><span class="op">(</span><span class="va">EEZs</span>, <span class="va">vel</span>, areapg <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
<p>Finally let’s plot the category proportions as pie charts on top of
each EEZ, the size of the chart being proportional to their respective
residence time (Fig. 3b in Garcia Molinos et al. 2019).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="co"># put data in long format</span></span>
<span><span class="co"># add EEZ names for reference</span></span>
<span><span class="va">D</span><span class="op">[</span>, <span class="va">name</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">EEZs</span><span class="op">$</span><span class="va">Territory1</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">D</span><span class="op">[</span>, <span class="va">RT</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">EEZa</span><span class="op">$</span><span class="va">resTim</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co"># prepare data frame to plot the pie charts with</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame.matrix</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="va">dt</span><span class="op">$</span><span class="va">country</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">EEZs</span><span class="op">$</span><span class="va">Territory1</span><span class="op">)</span></span>
<span><span class="va">dt</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">coordinates</span><span class="op">(</span><span class="va">EEZs</span><span class="op">)</span></span>
<span><span class="va">dt</span><span class="op">$</span><span class="va">RT</span> <span class="op">&lt;-</span> <span class="va">EEZa</span><span class="op">$</span><span class="va">resTim</span></span>
<span><span class="co"># generate the plot</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">velc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eez_simp</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">mycol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">192</span>, <span class="fl">192</span>, <span class="fl">192</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">204</span>, <span class="fl">255</span>, <span class="fl">204</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">255</span>, <span class="fl">153</span>, <span class="fl">51</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">255</span>, <span class="fl">51</span>, <span class="fl">51</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">51</span>, <span class="fl">51</span>, <span class="fl">255</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">204</span>, <span class="fl">102</span>, <span class="fl">0</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">204</span>, <span class="fl">0</span>, <span class="fl">204</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">255</span>, <span class="fl">255</span>, <span class="fl">51</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">153</span>, <span class="fl">204</span>, <span class="fl">255</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># mylab = c("Non-moving", "Slow-moving", "Internal Sink", "Boundary sink",</span></span>
<span><span class="co">#         "Source", "Internal sink","Corridor", "Divergence", "Convergence")</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">35</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">add.pie</span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">dt</span><span class="op">[</span><span class="va">i</span>, <span class="st">"x"</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">dt</span><span class="op">[</span><span class="va">i</span>, <span class="st">"y"</span><span class="op">]</span>, radius <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[</span><span class="va">i</span>, <span class="st">"RT"</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">mycol</span>, labels <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>García Molinos, J., Schoeman, D. S., Brown, C. J. and Burrows, M. T.
(2019), VoCC: An R package for calculating the velocity of climate
change and related climatic metrics. Methods Ecol Evol. <a href="doi:10.1111/2041-210X.13295" class="uri">doi:10.1111/2041-210X.13295</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jorge Garcia Molinos, David S. Schoeman, Christopher J. Brown, Michael T. Burrows.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
